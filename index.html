<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Improve test coverage on web application</title>

    <meta name="description" content="A framework for easily creating beautiful presentations using HTML">
    <meta name="author" content="Ricky Chien">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/moon.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
          <h2 style="text-overflow: normal;">Improve test coverage on<br>web application</h2>
          <p>
            <small>Created by <a href="mailto:ricky060709@gmail.com">Ricky Chien</a></small>
          </p>
        </section>

        <section>
          <h2>Outline</h2>
          <br>
          <ol>
            <li>Test coverage</li>
            <li>Web application</li>
            <li>Test coverage with dynamic loading</li>
            <li>Analysis of Script loading</li>
            <li>Methods</li>
            <li>Achievement</li>
            <li>Conclusion</li>
          </ol>
          <aside class="notes">
            Here is the outline today.
            First, introducing why is test coverage.
            Second, introducing nowadays web application
            Third, What will happened if we put both together.
            Then, analyze script loading approachs and describe my solution.
            In the end, I will give an achievement up to now.
          </aside>
        </section>

        <section>
          <section>
            <h2>Test coverage</h2>
          </section>

          <section>
            <h2>Why we need test coverage?</h2>
            <p class="fragment">For better software quality, we always write tests to ensure our program can execute correctly</p>
            <div class="fragment">
              <img src="assets/unittests.png" alt="unit tests">
              <small><p>A JavaScript unit tests example</p></small>
            </div>
          </section>

          <section>
              <p class="fragment">Coverage tool can give us a statistic report after testing</p>
            <div class="fragment">
              <img src="assets/coverage-report.png" alt="coverage-report">
              <small><p>Blanket.js - JavaScript test coverage tool</p></small>
            </div>
          </section>

          <section>
            <p>Even show source code coverage details</p>
            <img src="assets/coverage-report-details.png" alt="coverage-report-details">
          </section>
        </section>

        <section>
          <section>
            <h2>Web application</h2>
          </section>

          <section>
            <h2>Web is changing</h2>
            <ul>
              <li class="fragment"><p>Nowadays, web is going to become more complicated</p></li>
              <li class="fragment"><p>Client (Browser) can take more job than server</p></li>
              <li class="fragment"><p>Just like a desktop application but written by web technique</p></li>
            </ul>
            <div class="fragment">
              <img src="assets/gmail.png" alt="gmail" style="width: 680px; height: 400px;">
              <aside class="notes">
                Gmail work just like a desktop application
              </aside>
            </div>
          </section>

          <section>
            <h2>To build a complicated web application</h2>
            <ul>
              <li class="fragment"><p>Developers want to distribute JavaScript files to modules</p></li>
              <li class="fragment"><p>Web page is composed by modules or third-party libraries</p></li>
              <br>
              <p class="fragment" style="color: #99CCFF;">Web application is different with desktop application here</p>
            </ul>
            <div class="fragment">
              <img src="assets/browser-network.png" alt="browser-network">
              <br>
              <small><p>Web application load resources in background, but desktop application doesn't</p></small>
            </div>
          </section>

          <section>
            <h2>New issues</h2>
            <ul>
              <li class="fragment"><p>Too many scripts download will cause network slow down</p></li>
              <li class="fragment"><p>User always not use every functionality on website</p></li>
              <li class="fragment"><p>Some libraries are so huge that will stuck webpage on loading</p></li>
              <li class="fragment"><p>Some libraries are unnecessary when first time load</p></li>
            </ul>
          </section>

          <section>
            <h2>Solutions by script loading</h2>
            <ul>
              <li class="fragment"><p>Preloading</p></li>
              <li class="fragment"><p>Load on demand</p></li>
              <li class="fragment"><p>Load with async or defer</p></li>
            </ul>
            <aside class="notes">
              Load script on demand or through async or defer can be dynamic loading approach.
              When these dynamic loading technique meet with test coverage tool, new problem will arise.
            </aside>
          </section>
        </section>

        <section>
          <section>
            <h2>Test coverage with dynamic loading</h2>
          </section>

          <section>
            <h2>Zero coverage</h2>
            <div class="fragment">
              <ul>
                <li class="fragment">
                  <p>Firefox OS email app has 27 sources, but only covered one file</p>
                  <img src="assets/zero-coverage.png">
                </li>
                <li class="fragment">
                  <p>We demonstrate prevalent way of dynamic loading on web</p>
                  <a href="http://rickychien.github.io/lazyload-sample/old/">Lazyload-sample website</a>
                </li>
              </ul>
            </div>
          </section>

          <section>
            <h2>Analyze the causes</h2>
            <ul>
              <li class="fragment"><p>These coverage tool setup instrumentation scripts on beginning</p></li>
              <li class="fragment"><p>Load script dynamically through javascript is so hard to detect</p></li>
            </ul>
            <div class="fragment">
              <pre><code data-trim contenteditable>
var xhr = new XMLHttpRequest();
xhr.onload = function (responseScript) {
  // Execute response script
  eval(responseScript);
};
xhr.open('GET', 'URL');
xhr.send();
              </code></pre>
              <small><p>Ajax is a dynamic way to load scripts</p></small>
            </div>
          </section>
        </section>

        <section>
          <section>
            <h2>Analysis of Script loading</h2>
            <p>Demonstrate the web script loading approachs</p>
          </section>

          <section>
            <h2>Script Loading - HTML Script</h2>
            <br>
            <pre><code data-trim contenteditable>
&lt;script src=&quot;path/script.js&quot;&gt;&lt;/script&gt;
            </code></pre>
            <p>or</p>
            <pre><code data-trim contenteditable>
&lt;script&gt;
  // Script content
&lt;/script&gt;
            </code></pre>
            <br>
            <p style="color: #66CDAA;">Support</p>
          </section>

          <section>
            <h2>Script Loading - HTML Script (async/defer)</h2>
            <br>
            <pre><code data-trim contenteditable>
&lt;script src=&quot;path/script.js&quot; async&gt;&lt;/script&gt;
            </code></pre>
            <p>or</p>
            <pre><code data-trim contenteditable>
&lt;script src=&quot;path/script.js&quot; defer&gt;&lt;/script&gt;
            </code></pre>
            <br>
            <p style="color: #66CDAA;">Support</p>
          </section>

          <section>
            <h2>Script Loading - XHR (Ajax)</h2>
            <br>
            <pre><code data-trim contenteditable>
var xhr = new XMLHttpRequest();
xhr.onload = function (responseScript) {
  // Execute response script
  eval(responseScript);
};
xhr.open('GET', 'URL');
xhr.send();
            </code></pre>
            <br>
            <p style="color: #ff4629;">Need to support</p>
          </section>

          <section>
            <h2>Script Loading - Document.write</h2>
            <br>
            <pre><code data-trim contenteditable>
document.write('<script src="path/script.js"></script>');
            </code></pre>
            <br>
            <p style="color: #66CDAA;">Bad performance. Won't support</p>
          </section>

          <section>
            <h2>Script Loading - DOM modification API</h2>
            <br>
            <p>appendChild / insertBefore / replaceChild</p>
            <pre><code data-trim contenteditable>
var script = document.createElement("script");
script.src = url;

document.head.appendChild(script);
parentNode.insertBefore(script, node);
parentNode.replaceChild(script, oldNode);
            </code></pre>
            <br>
            <p style="color: #ff4629;">Need to support</p>
          </section>

          <section>
            <h2>Script Loading - Function Wrapping</h2>
            <br>
            <p>Famous module loader library such as RequireJS using syntax :</p>
            <pre><code data-trim contenteditable>
require(["path/script.js"], function() {
  // This function is called after path/script.js has loaded.
});
            </code></pre>
            <br>
            <p style="color: #ff4629;">Need to support</p>
          </section>

          <section>
            <p style="font-size: 50px; color: #ff4629;">Mechanism behind dynamic loading is native DOM modification API or XHR API</p>
          </section>
        </section>

        <section>
          <section>
            <h2>Methods</h2>
          </section>

          <section>
            <h2>Code Coverage Mechanism</h2>
            <img src="assets/code-coverage-workflow.png"></img>
          </section>

          <section>
            <h2>Solution</h2>
            <br>
            <ul>
              <li class="fragment"><p>Most of dynamic loading approachs are through DOM modification API and XHR.</p></li>
              <li class="fragment"><p>We can hack these native DOM modification API and XHR.</p></li>
              <li class="fragment"><p>A lot of tests are needed to ensure it doesn't break.</p></li>
            </ul>
          </section>

          <section>
            <h2>Solution</h2>
            <img src="assets/solution-mechanism.png"></img>
          </section>

          <section>
            <h2>DOM modification API</h2>
            <p>Overwrite original appendChild / insertBefore / replaceChild</p>
            <pre><code data-trim contenteditable>
Element.prototype.appendChild = function(newElement) {
    // Do our hack here
    return originalAppendChild.apply(this, args); // invoke original method
};

Element.prototype.insertBefore = function(newElement, referenceElement) {
    // Do our hack here
    return originalInsertBefore.apply(this, args); // invoke original method
};

Element.prototype.replaceChild = function(newElement, oldElement) {
    // Do our hack here
    return originalReplaceChild.apply(this, args); // invoke original method
};
            </code></pre>
          </section>

          <section>
            <h2>XHR API</h2>
            <p>Overwrite original open method in XHR object</p>
            <pre><code data-trim contenteditable>
XMLHttpRequest.prototype.open = function(method, url) {
  // Do our hack here
  return originalXHROpen.apply(this, args); // invoke original method
};
            </code></pre>
          </section>
        </section>

        <section>
          <section>
            <h2>Achievement</h2>
            <br>
            <p>A simple website for demo dynamic loading mechanism</p>
            <br>
            <ul>
              <li><a href="http://rickychien.github.io/lazyload-sample/old/">Without support lazyload</a></li>
              <li><a href="http://rickychien.github.io/lazyload-sample/new/">With support lazyload</a></li>
            </ul>
          </section>
        </section>

        <section>
          <h2>Conclusion</h2>
          <ul>
            <li class="fragment"><p>When test coverage meet with dynamic loading will cause zero coverage.</p></li>
            <li class="fragment"><p>Survey prevalent method of dynamic loading on web.</p></li>
            <li class="fragment"><p>Propose a solution to hack DOM API for addressing zero coverage.</p></li>
            <li class="fragment"><p>New mechanism succeed. Dynamic loading scripts have been covered.</p></li>
            <li class="fragment"><p>Need more testimonies to proof other coverage tools do not have such feature.</p></li>
          </ul>
        </section>

      </div>

    </div>
    <span class="slidenumber"></span>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>

    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Parallax scrolling
        // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
        // parallaxBackgroundSize: '2100px 900px',

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });

      function slidenumber(event) {
        //var totalslides = document.querySelectorAll( '.reveal .slides section:not(.stack)' ).length;
        var current_slide = 0;

        var horizontal_slides = document.querySelectorAll( '.reveal .slides>section' );
        for (var i = 0; i < event.indexh; i++) {
          // get subslides
          var subslides = horizontal_slides[i].querySelectorAll('section');

          // if subslides.length is 0, add 1 for horizontal slide, else add subslides.length
          current_slide += (subslides.length === 0) ? 1 : subslides.length;
        }

        current_slide += event.indexv + 1;
        return current_slide.toString(); // + " / " + totalslides.toString();
      }

      Reveal.addEventListener('slidechanged', function(event) {
        document.querySelector('.slidenumber').innerHTML = slidenumber(event);
      });

      Reveal.addEventListener('ready', function(event) {
        var div = document.querySelector('.reveal.center'),
            aside = document.createElement('aside');
        aside.setAttribute('class', 'controls slidenumber');
        aside.setAttribute('style', 'display: block; left: 10px; right: initial; bottom: -30px; text-align: center; color: rgb(47, 210, 233);');
        aside.innerHTML = slidenumber(event);
        div.appendChild(aside);
      });

    </script>

  </body>
</html>
